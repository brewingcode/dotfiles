#!/usr/bin/perl -w
use strict;

use Getopt::Long;

my $delay = 15;
my $at;
my $message = 'Here is your popup!';

GetOptions(
  'time=s'    => \$delay,
  'at=s'      => \$at,
  'message=s' => \$message,
) or die "invalid options";

if (defined $at) {
  my ($h, $m) = $at =~ /^(\d+):(\d+)$/ or die "--at must be 24-hour time format without seconds (xx:xx)";
  $delay = 3600 * ($h - (localtime)[2]);
  die "hour is behind current time" if $delay < 0;
  $delay += 60 * ($m - (localtime)[1]);
  die "time is behind current time" if $delay < 0;
}

my $h = $delay / 3600;
my $m = ($delay - int($h) * 3600) / 60;
my $s = $delay - int($h) * 3600 - int($m) * 60;

$message =~ s/"/\\"/g;

printf "popup in %02d:%02d:%02d\n", $h, $m, $s;

exit;

system qq|sleep $delay && osascript -e 'tell app "Terminal" to display alert "$message" buttons {"OK"} default button 1' > /dev/null 2>&1 &|;

