#!/usr/bin/env bash

cat > /tmp/cf.coffee <<EOF
cheerio = require('cheerio')
pretty = require('pretty')
fs = require('fs')

{ log } = console
js = JSON.stringify
html = fs.readFileSync "/dev/stdin", "utf8"
if (html.match /<(tr|td|th|thead|tbody|tfooter)/i) and (not html.match /<table/i)
  # table-children MUST have a <table> parent, otherwise the parsing is truly fucked
  html = "<table>#{html}</table>"
$ = cheerio.load html

EOF

if [ $# -eq 0 ]; then
  printf 'log pretty $.html()\n' >> /tmp/cf.coffee
else
  for x in "$@"; do
    printf "%s\n" "$x" >> /tmp/cf.coffee
  done
fi

coffee /tmp/cf.coffee
